<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${book.title} + ' - 북적북적'">책 상세 정보</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="relative flex min-h-screen flex-col bg-white" style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif;">
<div class="flex flex-col grow layout-container">
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="flex flex-1 justify-center px-6 md:px-40 py-6">
        <div class="w-full max-w-[960px] flex flex-col">

            <section class="grid grid-cols-[2fr_1fr_1fr] gap-1 @[480px]:gap-2 p-4 bg-white">
                <div class="bg-center bg-cover bg-no-repeat aspect-auto rounded-lg col-span-3 md:col-span-1"
                     th:style="'background-image: url(' + ${book.coverImageUrl} + ')'">
                </div>
            </section>

            <section class="px-4 pt-4">
                <h1 class="text-[22px] font-bold text-[#111418] pb-2" th:text="${book.title}">The Great Gatsby</h1>
                <p class="text-base text-[#111418] pb-2" th:text="${book.author} + ' | ' + ${book.publisher} + ' | ' + ${book.publicationYear}"></p>
            </section>

            <section class="px-4 pt-6">
                <h2 class="text-lg font-bold text-[#111418] pb-2">판매자 정보</h2>
                <div class="flex items-center gap-4 bg-white py-2">
                    <div class="size-14 aspect-square bg-center bg-cover rounded-full"
                         th:style="'background-image: url(' + ${book.sellerProfileImageUrl} + ')'">
                    </div>
                    <div>
                        <p class="text-base font-medium text-[#111418] line-clamp-1"
                            th:text="${book.sellerNickname}">판매자 닉네임</p>
                    </div>
                </div>
            </section>

            <section class="px-4 pt-6">
                <h2 class="text-lg font-bold text-[#111418] pb-2">책 상태</h2>
                <div class="flex items-center gap-4 py-2">
                    <div class="shrink-0 size-12 flex items-center justify-center rounded-lg bg-[#f0f2f5]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-base text-[#60748a]" th:text="${book.conditionGrade}" >최상</p>
                    </div>
                </div>
                <p class="text-base text-[#111418] py-2" th:text="${book.detailedCondition}">This book is in excellent condition...</p>
            </section>

            <section class="px-4 pt-6 pb-4">
                <h2 class="text-lg font-bold text-[#111418] pb-2">최종 가격</h2>
                <div class="flex justify-between items-center bg-white min-h-14">
                    <p class="text-xl font-bold text-[#111418] truncate" th:text="${#numbers.formatInteger(book.sellingPrice, 3, 'COMMA')} + '원'"></p>
                    <div class="flex items-center gap-2">
                        <div class="size-3 rounded-full bg-[#07883b]"></div>
                        <span class="text-sm font-medium text-[#07883b]" th:text="${book.status}">판매중</span>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <footer class="sticky bottom-0 border-t border-gray-200 bg-white">
        <div class="flex justify-between items-center gap-3 p-3 max-w-[960px] mx-auto">
            <button id="wishlist-button" class="min-w-[84px] h-12 px-4 bg-[#f0f2f5] text-[#111418] font-bold rounded-lg">찜하기</button>
            <button id="purchase-button" class="flex-1 min-w-[84px] h-12 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">채팅하기 / 구매 요청</button>
        </div>
    </footer>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const bookId = /*[[${book.id}]]*/ 'default';

    document.getElementById('wishlist-button').addEventListener('click', function() {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/api/wishlist?usedBookId=${bookId}`, {
            method: 'POST',
            headers: { [csrfHeader]: csrfToken }
        })
            .then(async response => {
                if (response.ok) {
                    alert('위시리스트에 추가되었습니다.');
                } else if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                } else if (response.status === 403) {
                    alert('보안 토큰이 유효하지 않습니다.');
                } else if (response.status === 409) {
                    alert('이미 찜한 책입니다.');
                } else {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.message || '찜하기 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                alert(error.message);
            });
    });

    document.getElementById('purchase-button').addEventListener('click', function() {
        if (!confirm('정말로 이 책을 구매하시겠습니까?')) {
            return;
        }

        fetch(`/api/used-books/${bookId}/purchase`, {
            method: 'POST',
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('구매 처리 중 문제가 발생했습니다.');
            })
            .then(message => {
                alert(message);
                window.location.reload();
            })
            .catch(error => {
                alert(error.message);
            });
    });
    /*]]>*/
</script>
</body>
</html>